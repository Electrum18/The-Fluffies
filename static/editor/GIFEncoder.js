var i=require("./TypedNeuQuant.js");var t=require("./LZWEncoder.js");function h(){this.page=-1;this.pages=[];this.i()}h.t=4096;h.s={};for(var s=0;s<256;s++)h.s[s]=String.fromCharCode(s);h.prototype.i=function(){this.pages[++this.page]=new Uint8Array(h.t);this.cursor=0};h.prototype.getData=function(){var i="";for(var t=0;t<this.pages.length;t++){for(var s=0;s<h.t;s++){i+=h.s[this.pages[t][s]]}}return i};h.prototype.h=function(i){if(this.cursor>=h.t)this.i();this.pages[this.page][this.cursor++]=i};h.prototype.u=function(i){for(var t=i.length,s=0;s<t;s++)this.h(i.charCodeAt(s))};h.prototype.o=function(i,t,s){for(var h=s||i.length,n=t||0;n<h;n++)this.h(i[n])};function n(i,t){this.width=~~i;this.height=~~t;this.v=null;this.l=0;this.repeat=-1;this.M=0;this.A=null;this.S=null;this.g=null;this.colorDepth=null;this.F=null;this.U=null;this.k=new Array;this.p=7;this.j=-1;this.q=true;this.N=10;this.T=false;this.m=false;this.C=new h}n.prototype.G=function(i){this.M=Math.round(i/10)};n.prototype.I=function(i){this.M=Math.round(100/i)};n.prototype.L=function(i){if(i>=0)this.j=i};n.prototype.P=function(i){this.repeat=i};n.prototype.W=function(i){this.v=i};n.prototype.Z=function(i){this.A=i;this.F=this.m&&this.m.slice?this.m:null;this.B();this.D();if(this.m===true)this.m=this.F;if(this.q){this.H();this.J();if(this.repeat>=0){this.K()}}this.O();this.R();if(!this.q&&!this.m)this.J();this.V();this.q=false};n.prototype.finish=function(){this.C.h(59)};n.prototype.X=function(i){if(i<1)i=1;this.N=i};n.prototype.Y=function(i){if(i===true)i="FloydSteinberg";this.T=i};n.prototype.$=function(i){this.m=i};n.prototype._=function(){return this.m&&this.m.slice&&this.m.slice(0)||this.m};n.prototype.ii=function(){this.C.u("GIF89a")};n.prototype.D=function(){if(!this.F){this.U=new i(this.S,this.N);this.U.ti();this.F=this.U.si()}if(this.T){this.hi(this.T.replace("-serpentine",""),this.T.match(/-serpentine/)!==null)}else{this.ni()}this.S=null;this.colorDepth=8;this.p=7;if(this.v!==null){this.l=this.ri(this.v,true)}};n.prototype.ni=function(i){var t=this.S.length/3;this.g=new Uint8Array(t);var s=0;for(var h=0;h<t;h++){var n=this.ai(this.S[s++]&255,this.S[s++]&255,this.S[s++]&255);this.k[n]=true;this.g[h]=n}};n.prototype.hi=function(i,t){var s={fi:[[3/8,1,0],[3/8,0,1],[2/8,1,1]],ui:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],ei:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],oi:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]]};if(!i||!s[i]){throw"Unknown dithering kernel: "+i}var h=s[i];var n=0,r=this.height,a=this.width,f=this.S;var u=t?-1:1;this.g=new Uint8Array(this.S.length/3);for(var e=0;e<r;e++){if(t)u=u*-1;for(var o=u==1?0:a-1,v=u==1?a:0;o!==v;o+=u){n=e*a+o;var l=n*3;var c=f[l];var w=f[l+1];var y=f[l+2];l=this.ai(c,w,y);this.k[l]=true;this.g[n]=l;l*=3;var M=this.F[l];var d=this.F[l+1];var A=this.F[l+2];var S=c-M;var g=w-d;var F=y-A;for(var U=u==1?0:h.length-1,k=u==1?h.length:0;U!==k;U+=u){var b=h[U][1];var p=h[U][2];if(b+o>=0&&b+o<a&&p+e>=0&&p+e<r){var E=h[U][0];l=n+b+p*a;l*=3;f[l]=Math.max(0,Math.min(255,f[l]+S*E));f[l+1]=Math.max(0,Math.min(255,f[l+1]+g*E));f[l+2]=Math.max(0,Math.min(255,f[l+2]+F*E))}}}}};n.prototype.ri=function(i,t){return this.ai((i&16711680)>>16,(i&65280)>>8,i&255,t)};n.prototype.ai=function(i,t,s,h){if(this.F===null)return-1;if(this.U&&!h){return this.U.vi(i,t,s)}var n=s|t<<8|i<<16;var r=0;var a=256*256*256;var f=this.F.length;for(var u=0,e=0;u<f;e++){var o=i-(this.F[u++]&255);var v=t-(this.F[u++]&255);var l=s-(this.F[u++]&255);var c=o*o+v*v+l*l;if((!h||this.k[e])&&c<a){a=c;r=e}}return r};n.prototype.B=function(){var i=this.width;var t=this.height;this.S=new Uint8Array(i*t*3);var s=this.A;var h=0;var n=0;for(var r=0;r<t;r++){for(var a=0;a<i;a++){this.S[n++]=s[h++];this.S[n++]=s[h++];this.S[n++]=s[h++];h++}}};n.prototype.O=function(){this.C.h(33);this.C.h(249);this.C.h(4);var i,t;if(this.v===null){i=0;t=0}else{i=1;t=2}if(this.j>=0){t=this.j&7}t<<=2;this.C.h(0|t|0|i);this.li(this.M);this.C.h(this.l);this.C.h(0)};n.prototype.R=function(){this.C.h(44);this.li(0);this.li(0);this.li(this.width);this.li(this.height);if(this.q||this.m){this.C.h(0)}else{this.C.h(128|0|0|0|this.p)}};n.prototype.H=function(){this.li(this.width);this.li(this.height);this.C.h(128|112|0|this.p);this.C.h(0);this.C.h(0)};n.prototype.K=function(){this.C.h(33);this.C.h(255);this.C.h(11);this.C.u("NETSCAPE2.0");this.C.h(3);this.C.h(1);this.li(this.repeat);this.C.h(0)};n.prototype.J=function(){this.C.o(this.F);var i=3*256-this.F.length;for(var t=0;t<i;t++)this.C.h(0)};n.prototype.li=function(i){this.C.h(i&255);this.C.h(i>>8&255)};n.prototype.V=function(){var i=new t(this.width,this.height,this.g,this.colorDepth);i.encode(this.C)};n.prototype.stream=function(){return this.C};module.ci=n;